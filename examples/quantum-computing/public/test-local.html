<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’±åŒ…è¿æ¥æµ‹è¯•ï¼ˆæœ¬åœ°ç‰ˆï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #5568d3;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— é’±åŒ…è¿æ¥æµ‹è¯•ï¼ˆæœ¬åœ°ç‰ˆï¼‰</h1>

        <div id="status" class="status info">
            ç­‰å¾…è¿æ¥...
        </div>

        <button onclick="testMetaMask()">1. æ£€æµ‹ MetaMask</button>
        <button onclick="testConnect()">2. è¿æ¥é’±åŒ…</button>
        <button onclick="testEthers()">3. æµ‹è¯• Ethers.js</button>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>

        <h3>è¯¦ç»†æ—¥å¿—ï¼š</h3>
        <pre id="log"></pre>
    </div>

    <!-- ä½¿ç”¨æœ¬åœ° ethers.js -->
    <script src="./ethers.min.js"></script>
    <script>
        let logMessages = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸'
            }[type] || 'â„¹ï¸';

            logMessages.push(`[${timestamp}] ${prefix} ${message}`);
            document.getElementById('log').textContent = logMessages.join('\n');
            console.log(`[${type}] ${message}`);
        }

        function setStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function clearLog() {
            logMessages = [];
            document.getElementById('log').textContent = '';
            setStatus('æ—¥å¿—å·²æ¸…é™¤', 'info');
        }

        // æµ‹è¯• 1: æ£€æµ‹ MetaMask
        async function testMetaMask() {
            log('=== å¼€å§‹æ£€æµ‹ MetaMask ===');

            // æ£€æŸ¥ window.ethereum
            if (typeof window.ethereum === 'undefined') {
                log('âŒ æœªæ£€æµ‹åˆ° window.ethereum', 'error');
                setStatus('æœªå®‰è£… MetaMask æˆ–æµè§ˆå™¨ä¸æ”¯æŒ', 'error');
                return false;
            }

            log('âœ… window.ethereum å­˜åœ¨', 'success');
            log(`æä¾›è€…: ${window.ethereum.isMetaMask ? 'MetaMask' : 'å…¶ä»–é’±åŒ…'}`, 'info');

            // æ£€æŸ¥ ethers.js
            if (typeof ethers === 'undefined') {
                log('âŒ ethers.js æœªåŠ è½½', 'error');
                setStatus('ethers.js åº“åŠ è½½å¤±è´¥', 'error');
                return false;
            }

            log(`âœ… ethers.js ç‰ˆæœ¬: ${ethers.version}`, 'success');
            setStatus('MetaMask æ£€æµ‹æˆåŠŸï¼', 'success');
            return true;
        }

        // æµ‹è¯• 2: è¿æ¥é’±åŒ…
        async function testConnect() {
            log('=== å¼€å§‹è¿æ¥é’±åŒ… ===');

            try {
                // å…ˆæ£€æµ‹
                const detected = await testMetaMask();
                if (!detected) {
                    return;
                }

                log('æ­£åœ¨è¯·æ±‚è´¦æˆ·è®¿é—®...', 'info');
                setStatus('è¯·åœ¨ MetaMask ä¸­ç¡®è®¤è¿æ¥...', 'info');

                // è¯·æ±‚è´¦æˆ·
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    log('âŒ æœªè·å–åˆ°è´¦æˆ·', 'error');
                    setStatus('è¿æ¥è¢«æ‹’ç»æˆ–æ— å¯ç”¨è´¦æˆ·', 'error');
                    return;
                }

                log(`âœ… è·å–åˆ° ${accounts.length} ä¸ªè´¦æˆ·`, 'success');
                log(`è´¦æˆ·åœ°å€: ${accounts[0]}`, 'info');

                // è·å–ç½‘ç»œä¿¡æ¯
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`ç½‘ç»œ Chain ID: ${chainId} (${parseInt(chainId, 16)})`, 'info');

                // è·å–ä½™é¢
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [accounts[0], 'latest']
                });
                const balanceEth = parseInt(balance, 16) / 1e18;
                log(`è´¦æˆ·ä½™é¢: ${balanceEth.toFixed(4)} ETH`, 'info');

                setStatus(`è¿æ¥æˆåŠŸï¼åœ°å€: ${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`, 'success');

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                log(`é”™è¯¯ä»£ç : ${error.code || 'N/A'}`, 'error');
                setStatus('è¿æ¥å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æµ‹è¯• 3: æµ‹è¯• Ethers.js Provider
        async function testEthers() {
            log('=== æµ‹è¯• Ethers.js Provider ===');

            try {
                if (typeof ethers === 'undefined') {
                    log('âŒ ethers.js æœªåŠ è½½', 'error');
                    return;
                }

                log('åˆ›å»º Web3Provider...', 'info');
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                log('âœ… Provider åˆ›å»ºæˆåŠŸ', 'success');

                log('è·å– signer...', 'info');
                const signer = provider.getSigner();
                log('âœ… Signer åˆ›å»ºæˆåŠŸ', 'success');

                log('è·å–åœ°å€...', 'info');
                const address = await signer.getAddress();
                log(`âœ… åœ°å€: ${address}`, 'success');

                log('è·å–ç½‘ç»œä¿¡æ¯...', 'info');
                const network = await provider.getNetwork();
                log(`âœ… ç½‘ç»œåç§°: ${network.name}`, 'success');
                log(`âœ… Chain ID: ${network.chainId}`, 'success');

                log('è·å–ä½™é¢...', 'info');
                const balance = await provider.getBalance(address);
                log(`âœ… ä½™é¢: ${ethers.utils.formatEther(balance)} ETH`, 'success');

                log('è·å–åŒºå—å·...', 'info');
                const blockNumber = await provider.getBlockNumber();
                log(`âœ… å½“å‰åŒºå—: ${blockNumber}`, 'success');

                setStatus('Ethers.js æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');

            } catch (error) {
                log(`âŒ Ethers.js æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                setStatus('Ethers.js æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ', 'info');
            setTimeout(() => {
                testMetaMask();
            }, 500);
        });

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                log(`è´¦æˆ·å·²å˜æ›´: ${accounts[0] || 'æ— è´¦æˆ·'}`, 'warning');
            });

            window.ethereum.on('chainChanged', (chainId) => {
                log(`ç½‘ç»œå·²å˜æ›´: ${chainId}`, 'warning');
                window.location.reload();
            });
        }
    </script>
</body>
</html>
